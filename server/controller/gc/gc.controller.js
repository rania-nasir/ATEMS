const { sequelize } = require("../../config/sequelize");
const { faculties } = require("../../model/faculty.model");
const { students } = require("../../model/student.model");
const { announcements } = require("../../model/announcement.model");
const { sendMail } = require("../../config/mailer");
const { generateToken } = require('../../middleware/authMiddleware');
const { Op } = require('sequelize');

//GC login
const GCSignIn = async (req, res) => {
  try {
    const gcid = req.body.gcid;
    const password = req.body.password;
    await sequelize.sync();

    const resp = await faculties.findOne({
      where: {
        facultyid: gcid,
        password: password,
        role: {
          [Op.contains]: ["GC"] // searching in faculties table for GC role
        },
      },
    });

    if (!resp) {
      return res.status(404).json({ error: 'GC Login Forbidden' }); // if role not found on the user entered id and pass then display forbidden message
    }

    if (resp) {
      const token = generateToken(gcid, 'gc'); // create token for gc

      console.log(`${gcid}, ${password}, `, token); // logging sign in
      const userType = 'gc';
      const userId = gcid;
      //console.log('userID: ', userId, ', userType: ', userType);
      res.cookie('jwtoken', token, { // creating cookie
        expiresIn: 3 * 24 * 60 * 60,
        httpOnly: true
      })
      res.status(200).json({ message: 'Sign In successfully from Server side', token, userId, userType });
    } else {
      res.json({ message: 'Invalid Credentials' });
    }
  } catch (error) {
    console.error('Failed to retrieve data: ', error);
    res.status(500).json({ message: 'Internal Server Error from Server side' });
  }
};


// Assigning random password
// Helper function to generate passwords
function generateRandomPassword(length) {
  const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789~!@#$%^&*_'; // creating random password from these characters
  let password = '';
  for (let i = 0; i < length; i++) { // randomizing the characters
    const randomIndex = Math.floor(Math.random() * characters.length);
    password += characters[randomIndex];
  }
  return password;
}

// Add student function
const addStudent = async (req, res) => {
  try {
    const autoGeneratedPassword = generateRandomPassword(8); // using the helper function to generate random passwords
    const rollno = req.body.rollno;
    const name = req.body.name;
    const email = req.body.email;
    const gender = req.body.gender;
    const batch = req.body.batch;
    const semester = req.body.semester;
    const program = req.body.program;
    const cgpa = req.body.cgpa;
    const mobile = req.body.mobile;
    const password = autoGeneratedPassword;

    // Check if student with the same roll number already exists
    const existingStudent = await students.findOne({ where: { rollno } });
    if (existingStudent) {
      return res.status(409).json({ error: "Student with the same roll number already exists" });
    }

    /* Validations for Inputs */

    const rollnoRegex = /^\d{2}[A-Z]-\d{4}$/;
    if (!rollnoRegex.test(rollno)) {
      return res.status(400).json({ error: "Invalid roll number format" });
    }


    const emailRegex = /^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/;
    if (!emailRegex.test(email)) {
      return res.status(400).json({ error: "Invalid email format" });
    }

    // Validate batch is less than the present year
    const currentYear = new Date().getFullYear();
    if (batch >= currentYear) {
      return res.status(400).json({ error: "Invalid batch year" });
    }

    if (cgpa > 4) {
      return res.status(400).json({ error: "Invalid CGPA. CGPA must be less than or equal to 4" });
    }

    // Check eligibility for synopsis registration
    if (cgpa < 2) {
      return res.status(400).json({ error: "Student is not eligible for synopsis registration" });
    }

    const mobileRegex = /^\d{11}$/;
    if (!mobileRegex.test(mobile)) {
      return res.status(400).json({ error: "Invalid mobile number format" });
    }

    await students.create({ // creating a row in the table with the information
      rollno: rollno,
      name: name,
      email: email,
      gender: gender,
      batch: batch,
      semester: semester,
      program: program,
      cgpa: cgpa,
      mobile: mobile,
      password: password
    });
    res.status(200).json('Student record added successfully');

    // Writing email with password

    const toEmail = email; // Use the student's email address
    const subject = 'Weclome to ATEMS';
    const text = `Your credential to login in to system are as follows:
    Username :${rollno}
    Password :${autoGeneratedPassword}`;
    sendMail(toEmail, subject, text);

  } catch (error) {
    console.error('Failed to retrieve data: ', error);
    res.status(500).json('Internal Server Error');
  }
};

// View All Present students in the system
const viewStudents = async (req, res) => {
  try {
    const studentsnData = await students.findAll({
      attributes: ['rollno', 'name', 'batch', 'semester', 'program', 'cgpa']
    });
    res.json(studentsnData);
  } catch (error) {
    console.error('Failed to retrieve data: ', error);
    res.status(500).send.json('Internal Server Error');
  }
}

// Adding Faculty members
const addFaculty = async (req, res) => {
  try {
    const autoGeneratedPassword = generateRandomPassword(8); // using helper function to generate password
    const facultyid = req.body.facultyid;
    const name = req.body.name;
    const email = req.body.email;
    const gender = req.body.gender;
    const role = req.body.role;
    const mobile = req.body.mobile;
    const password = autoGeneratedPassword;

    /* Validations */

    const emailRegex = /^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/;
    if (!emailRegex.test(email)) {
      return res.status(400).json({ error: "Invalid email format" });
    }

    const mobileRegex = /^\d{11}$/;
    if (!mobileRegex.test(mobile)) {
      return res.status(400).json({ error: "Invalid mobile number format" });
    }

    const facultyIdRegex = /^\d{4}$/;
    if (!facultyIdRegex.test(facultyid)) {
      return res.status(400).json({ error: "Invalid faculty ID format" });
    }

    await faculties.create({
      facultyid: facultyid,
      name: name,
      email: email,
      gender: gender,
      role: role,
      mobile: mobile,
      password: password
    });
    res.status(200).json('Faculty record added successfully');

    //Writing email with generated password
    const toEmail = email; // Use the faulty's email address
    const subject = 'Weclome to ATEMS';
    const text = `Your credential to login in to system are as follows:
    Username :${facultyid}
    Password :${autoGeneratedPassword}`;
    sendMail(toEmail, subject, text);

  } catch (error) {
    console.error('Failed to retrieve data: ', error);
    res.status(500).json('Internal Server Error');
  }
}

// View All Faculty Members
const viewFaculty = async (req, res) => {
  try {
    const facultyMembers = await faculties.findAll({
      attributes: ['facultyid', 'name', 'email']
    });
    res.json(facultyMembers);
  } catch (error) {
    console.error('Failed to retrieve data: ', error);
    res.status(500).json('Internal Server Error');
  }
};

// Add Announcement
const addAnnouncement = async (req, res) => {
  try {
    const announcementID = req.body.announcementID;
    const announcementType = req.body.announcementType;
    const announcementTitle = req.body.announcementTitle;
    const announcementContent = req.body.announcementContent;

    await announcements.create({
      announcementID,
      announcementType,
      announcementTitle,
      announcementContent
    });

    if (announcementType === 'Student' || announcementType === 'Both') {
      const Students = await students.findAll();

      // Send email to all students
      Students.forEach((student) => {
        const toEmail = student.email;
        const subject = announcementTitle;
        const text = announcementContent.slice(0, 50);
        sendMail(toEmail, subject, text);
      });
    }

    if (announcementType === 'Faculty' || announcementType === 'Both') {
      const Faculties = await faculties.findAll();

      // Send email to all faculties
      Faculties.forEach((faculty) => {
        const toEmail = faculty.email;
        const subject = announcementTitle;
        const text = announcementContent.slice(0, 50) + "........ Check the system to see full announcement";
        sendMail(toEmail, subject, text);
      });
    }

    res.status(200).json('Announcement record added successfully');
  } catch (error) {
    console.error('Failed to retrieve data: ', error);
    res.status(500).json('Internal Server Error');
  }
};

module.exports =
{
  GCSignIn,
  addStudent,
  viewStudents,
  addFaculty,
  viewFaculty,
  addAnnouncement
};
